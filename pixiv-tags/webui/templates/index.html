<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixiv Tag ç¿»è¯‘å®¡æ ¸å·¥å…·</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Pixiv Tag ç¿»è¯‘å®¡æ ¸å·¥å…·</h1>
            <div class="stats">
                <span>æ€»æ ‡ç­¾æ•°: {{ stats.total }}</span>
                <span class="reviewed">å·²å®¡æ ¸: {{ stats.reviewed }}</span>
                <span class="pending">å¾…å®¡æ ¸: {{ stats.pending }}</span>
                <span>è¿›åº¦: {{ "{:.1f}%".format(stats.reviewed / stats.total * 100) if stats.total > 0 else "0%" }}</span>
            </div>
            <div class="language-toggle">
                <button class="lang-btn {{ 'active' if language == 'chinese' else '' }}" onclick="switchLanguage('chinese')">ä¸­æ–‡å®¡æ ¸</button>
                <button class="lang-btn {{ 'active' if language == 'english' else '' }}" onclick="switchLanguage('english')">è‹±æ–‡å®¡æ ¸</button>
            </div>
        </header>

        {% if tag %}
        <main>
            <div class="tag-display">
                <div class="field">
                    <label>åŸæ–‡:</label>
                    <span class="value">{{ tag.name }}</span>
                </div>
                <div class="field">
                    <label>å®˜æ–¹è¯‘æ–‡:</label>
                    <span class="value">{{ tag.official_translation or '(æ— )' }}</span>
                </div>
                <div class="field">
                    <label>LLM è¯‘æ–‡:</label>
                    <span class="value">{{ tag.chinese_translation if language == 'chinese' else tag.english_translation or '(æ— )' }}</span>
                </div>
            </div>

            <div class="translation-editor">
                <label for="translation-input">ç¼–è¾‘{{ 'ä¸­æ–‡' if language == 'chinese' else 'è‹±æ–‡' }}è¯‘æ–‡:</label>
                <textarea id="translation-input" rows="3">{{ tag.chinese_translation if language == 'chinese' else tag.english_translation }}</textarea>

                <div class="quick-actions">
                    <button onclick="copyOriginal()">å¤åˆ¶åŸæ–‡</button>
                    <button onclick="copyOfficial()" {% if not tag.official_translation %}disabled{% endif %}>å¤åˆ¶å®˜æ–¹è¯‘æ–‡</button>
                    <button onclick="searchPixiv()">æœç´¢ Pixiv</button>
                </div>
            </div>

            <div class="navigation">
                <div class="nav-group">
                    <span class="nav-label">æ‰€æœ‰æ ‡ç­¾</span>
                    <div class="nav-buttons">
                        <button onclick="prevTag()">ä¸Šä¸€ä¸ª</button>
                        <button onclick="nextTag()">ä¸‹ä¸€ä¸ª</button>
                    </div>
                </div>

                <div class="nav-group">
                    <span class="nav-label">æœªå®¡æ ¸æ ‡ç­¾</span>
                    <div class="nav-buttons">
                        <button onclick="prevUnreviewed()">ä¸Šä¸€ä¸ªæœªå®¡æ ¸</button>
                        <button onclick="nextUnreviewed()">ä¸‹ä¸€ä¸ªæœªå®¡æ ¸</button>
                    </div>
                </div>
            </div>

            <div class="save-section">
                <button class="save-btn" onclick="saveTranslation()">ä¿å­˜å¹¶æ ‡è®°å·²å®¡æ ¸</button>
            </div>
        </main>
        {% else %}
        <main>
            <div class="no-tags">
                <p>æ²¡æœ‰å¾…å®¡æ ¸çš„æ ‡ç­¾</p>
                <p>æ‰€æœ‰æ ‡ç­¾éƒ½å·²å®¡æ ¸å®Œæˆï¼ğŸ‰</p>
            </div>
        </main>
        {% endif %}
    </div>

    <script>
        let currentIndex = {{ index }};
        let currentLanguage = '{{ language }}';
        let currentTagName = '{{ tag.name if tag else "" }}';

        function switchLanguage(lang) {
            const url = new URL(window.location);
            url.searchParams.set('language', lang);
            url.searchParams.set('index', 0);
            window.location.href = url.toString();
        }

        function copyOriginal() {
            document.getElementById('translation-input').value = currentTagName;
        }

        function copyOfficial() {
            {% if tag.official_translation %}
            document.getElementById('translation-input').value = '{{ tag.official_translation }}';
            {% endif %}
        }

        function searchPixiv() {
            const tag = encodeURIComponent(currentTagName);
            window.open(`https://www.pixiv.net/tags/${tag}/artworks`, '_blank');
        }

        async function updateStats() {
            try {
                const response = await fetch(`/api/stats?language=${currentLanguage}`);
                if (response.ok) {
                    const stats = await response.json();
                    const statsContainer = document.querySelector('.stats');
                    const progress = stats.total > 0 ? (stats.reviewed / stats.total * 100).toFixed(1) : '0';
                    statsContainer.innerHTML = `
                        <span>æ€»æ ‡ç­¾æ•°: ${stats.total}</span>
                        <span class="reviewed">å·²å®¡æ ¸: ${stats.reviewed}</span>
                        <span class="pending">å¾…å®¡æ ¸: ${stats.pending}</span>
                        <span>è¿›åº¦: ${progress}%</span>
                    `;
                }
            } catch (error) {
                console.error('æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        async function saveTranslation() {
            const translation = document.getElementById('translation-input').value.trim();

            try {
                const response = await fetch('/api/tag/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: currentTagName,
                        language: currentLanguage,
                        translation: translation,
                        reviewed: true
                    })
                });

                const data = await response.json();

                if (data.success) {
                    await updateStats();
                    nextTag();
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        async function nextTag() {
            try {
                const response = await fetch(`/api/tag/next?current_index=${currentIndex}&language=${currentLanguage}`);
                
                if (response.ok) {
                    const data = await response.json();
                    currentIndex = data.index;
                    currentTagName = data.name;
                    updateUI(data);
                } else {
                    alert('æ²¡æœ‰æ›´å¤šæ ‡ç­¾äº†');
                }
            } catch (error) {
                console.error('è·å–ä¸‹ä¸€ä¸ªæ ‡ç­¾å¤±è´¥:', error);
            }
        }

        async function prevTag() {
            try {
                const response = await fetch(`/api/tag/prev?current_index=${currentIndex}&language=${currentLanguage}`);

                if (response.ok) {
                    const data = await response.json();
                    currentIndex = data.index;
                    currentTagName = data.name;
                    updateUI(data);
                }
            } catch (error) {
                console.error('è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾å¤±è´¥:', error);
            }
        }

        async function nextUnreviewed() {
            try {
                const response = await fetch(`/api/tag/next-unreviewed?current_tag_name=${encodeURIComponent(currentTagName)}&language=${currentLanguage}`);

                if (response.ok) {
                    const data = await response.json();
                    currentTagName = data.name;
                    updateUI(data);
                } else {
                    alert('æ²¡æœ‰æ›´å¤šæœªå®¡æ ¸çš„æ ‡ç­¾äº†');
                }
            } catch (error) {
                console.error('è·å–ä¸‹ä¸€ä¸ªæœªå®¡æ ¸æ ‡ç­¾å¤±è´¥:', error);
            }
        }

        async function prevUnreviewed() {
            try {
                const response = await fetch(`/api/tag/prev-unreviewed?current_tag_name=${encodeURIComponent(currentTagName)}&language=${currentLanguage}`);

                if (response.ok) {
                    const data = await response.json();
                    if (data) {
                        currentTagName = data.name;
                        updateUI(data);
                    } else {
                        alert('æ²¡æœ‰æ›´å¤šæœªå®¡æ ¸çš„æ ‡ç­¾äº†');
                    }
                }
            } catch (error) {
                console.error('è·å–ä¸Šä¸€ä¸ªæœªå®¡æ ¸æ ‡ç­¾å¤±è´¥:', error);
            }
        }

        function updateUI(data) {
            const translation = currentLanguage === 'chinese' ? data.chinese_translation : data.english_translation;
            const llmTranslation = currentLanguage === 'chinese' ? data.chinese_translation : data.english_translation;
            
            document.querySelector('.field:nth-child(1) .value').textContent = data.name;
            document.querySelector('.field:nth-child(2) .value').textContent = data.official_translation || '(æ— )';
            document.querySelector('.field:nth-child(3) .value').textContent = llmTranslation || '(æ— )';
            document.getElementById('translation-input').value = translation || '';
            
            currentTagName = data.name;
            
            const url = new URL(window.location);
            url.searchParams.set('index', currentIndex);
            window.history.replaceState({}, '', url);
        }

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveTranslation();
                }
            }
            if (e.key === 'ArrowLeft' && !e.target.matches('textarea')) {
                if (e.altKey) {
                    e.preventDefault();
                    prevUnreviewed();
                } else {
                    prevTag();
                }
            }
            if (e.key === 'ArrowRight' && !e.target.matches('textarea')) {
                if (e.altKey) {
                    e.preventDefault();
                    nextUnreviewed();
                } else {
                    nextTag();
                }
            }
        });
    </script>
</body>
</html>