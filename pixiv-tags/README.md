# Pixiv Tags Collector

一个用于收集 Pixiv 标签的 Python 工具，采用基于推荐流的深度优先算法高效发现相关标签。

## 🚀 功能特性

- ✅ **推荐流深度优先**：从推荐插画开始，沿标签链深入探索
- ✅ **智能去重**：避免重复处理相同的标签和插画
- ✅ **深度控制**：可配置的最大探索深度防止无限循环
- ✅ **自动认证**：自动处理认证和 token 刷新
- ✅ **429错误自动处理**：检测到速率限制时自动等待5分钟后重试
- ✅ **可配置重试策略**：支持自定义等待时间和重试次数
- ✅ **内存缓存**：启动时加载到内存，提高性能
- ✅ **定期自动保存**：每 20 个新标签自动保存到文件
- ✅ **优雅退出**：Ctrl+C 时自动保存内存中的数据
- ✅ **无状态推荐**：每次重启获取新的推荐内容，无需进度管理
- ✅ **实时统计**：显示处理速度和进度信息
- ✅ **详细的日志记录**
- ✅ **错误恢复和备份机制**
- ✅ **WebUI 审核**：可视化审核 LLM 翻译的标签

## 📦 安装依赖

```bash
uv sync
```

## ⚙️ 配置

1. 复制环境变量模板：
```bash
cp .env.example .env
```

2. 编辑 `.env` 文件，配置所有必要参数：

```bash
# Pixiv API 认证（必须）
REFRESH_TOKEN=your_refresh_token_here

# 推荐流深度限制 (默认: 3)
MAX_DEPTH=3

# 429 错误重试配置
PIXIV_429_WAIT_TIME=300          # 等待时间(秒)，默认5分钟
PIXIV_429_MAX_RETRIES=3           # 最大重试次数，默认3次

# 数据存储配置
TAGS_FILE_PATH=data/tags.json     # 标签数据文件路径

# 日志配置
LOG_FILE_PATH=pixiv_tags.log      # 日志文件路径
LOG_LEVEL=INFO                    # 日志级别 (DEBUG, INFO, WARNING, ERROR)

# 收集器配置
SAVE_INTERVAL=20                   # 自动保存间隔(标签数)
```

> 获取 refresh_token 的方法请参考 [PixivPy 文档](https://github.com/upbit/pixivpy)

## 🎯 运行

### 基本用法

```bash
uv run main.py
```

### WebUI 审核工具

启动 WebUI 进行标签翻译审核：

```bash
uv run run_webui.py
```

访问 http://localhost:5000 开始审核。

**WebUI 功能**：
- 一次显示一个标签（原文、官方译文、LLM 译文）
- 快捷操作：复制原文、复制官方译文、搜索 Pixiv
- 导航：上一个、下一个标签
- 保存并标记已审核
- 支持中文和英文翻译审核
- 按频率排序，优先显示未审核的标签
- 实时显示审核进度

**快捷键**：
- `Ctrl/Cmd + Enter`：保存并标记已审核
- `←`：上一个标签
- `→`：下一个标签

### 🎮 环境变量配置

所有配置都通过 `.env` 文件管理，无需命令行参数。

### 🧪 测试配置

```bash
# 测试环境变量配置是否正确
uv run python test_env.py
```

## 🛡️ 安全退出

程序支持优雅退出，按 `Ctrl+C` 可以安全停止：
- 程序会立即停止处理新的请求
- **自动保存内存中的所有标签到文件**
- 显示进度统计信息
- 不会出现 traceback 错误

## 🧠 算法说明

### 深度优先策略

1. **获取推荐插画**：从用户推荐流获取30个热门插画作为起点
2. **提取初始标签**：从推荐插画中提取所有标签
3. **深度优先搜索**：
   - 对每个新标签搜索相关插画
   - 从新插画中提取更多标签
   - 继续深入直到达到最大深度
4. **智能去重**：避免重复处理相同的标签和插画

### 📊 深度建议

| 深度值 | 适用场景 | 预计处理量 | 耗时估算 |
|--------|----------|------------|----------|
| 1      | 快速测试 | ~50-100标签 | 5-10分钟 |
| 2      | 轻量收集 | ~200-500标签 | 20-40分钟 |
| 3      | 标准收集 | ~500-1000标签 | 1-2小时 |
| 4+     | 深度收集 | 1000+标签 | 2小时+ |

## 💾 内存管理和自动保存

- **启动时**：自动加载 `data/tags.json` 到内存
- **运行时**：所有新标签先添加到内存，进行去重
- **自动保存**：每收集 20 个新标签自动保存到文件
- **退出时**：确保内存中的所有标签都保存到文件

## 📈 无状态设计

- **推荐模式**：每次重启都会获取新的推荐内容
- **实时保存**：定期自动保存新发现的标签到 JSON 文件
- **追加模式**：新标签会追加到现有数据中，不会覆盖
- **优雅退出**：Ctrl+C 时自动保存内存中的所有标签

## 📄 输出格式

标签数据保存在 `data/tags.json` 文件中：

```json
{
  "tags": [
    {
      "name": "原神",
      "official_translation": "Genshin Impact",
      "chinese_translation": "",
      "english_translation": ""
    },
    {
      "name": "FGO",
      "official_translation": "",
      "chinese_translation": "",
      "english_translation": ""
    }
  ]
}
```

## 📝 日志文件

程序运行时会生成 `pixiv_tags.log` 日志文件，包含详细的操作记录和错误信息。

## 🔧 技术实现

### API 接口
基于 SwiftUI 项目的 API 实现：
- `GET /v1/illust/recommended` - 获取推荐插画流
- `GET /v1/search/illust` - 按标签搜索插画
- 完整的标签翻译信息支持

### 核心组件

- **RecommendationBasedCollector**：深度优先标签收集器（无状态）
- **SearchAPI**：Pixiv API 封装
- **PixivTag**：标签数据模型
- **TagStorage**：标签存储管理

## 🐛 故障排除

### 标签没有保存？
检查日志文件 `pixiv_tags.log` 查看是否有错误信息。如果保存失败，程序会创建备份文件。

### 认证失败？
确保 `.env` 文件中的 `REFRESH_TOKEN` 是有效的。如果 token 过期，需要重新获取。

### 网络错误？
程序会自动重试失败的请求。如果持续失败，检查网络连接或代理设置。

### 429错误（请求过多）？
- **自动处理**：程序会自动等待指定时间后重试
- **自定义配置**：通过 `.env` 文件配置 `PIXIV_429_WAIT_TIME` 和 `PIXIV_429_MAX_RETRIES` 
- **降低频率**：如果频繁遇到429错误，可以适当减少请求频率
- **耐心等待**：429错误是Pixiv API的正常保护机制，请耐心等待

### 深度太深导致处理缓慢？
- 减少 `.env` 文件中的 `MAX_DEPTH` 值
- 每次重启都会获取新的推荐内容，无需重置

---

这个工具采用先进的深度优先算法，能够高效地发现相关的 Pixiv 标签，相比传统的字符匹配方式具有更高的质量和相关性。🎉